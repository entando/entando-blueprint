<%# { "useBluePrint": true, "renameTo": "`/${generator.entityInstance}/tableWidget/src/api/${generator.entityInstancePlural}.js`" } -%>
import { DOMAIN } from 'api/constants';
import { getFilterQuery } from 'components/filters/utils';

const getKeycloakToken = () => {
  if (
    window &&
    window.entando &&
    window.entando.keycloak &&
    window.entando.keycloak.authenticated
  ) {
    return window.entando.keycloak.token;
  }
  return '';
};

const request = async (url, options) => {
  const response = await fetch(url, options);

  return response.status >= 200 && response.status < 300
    ? response.json()
    : Promise.reject(new Error(response.statusText || response.status));
};

/* eslint-disable-next-line import/prefer-default-export */
export const api<%= entityClassPlural %>Get = async ({ filters = [] }) => {
  const query = getFilterQuery(filters);

  const url = `${DOMAIN}/<%= entityApiUrl %>${query ? `?${query}` : ''}`;

  const token = getKeycloakToken();

  const defaultOptions = {
    headers: new Headers({
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json',
    }),
  };

  const options = {
    ...defaultOptions,
    method: 'GET',
  };
  return request(url, options);
};
